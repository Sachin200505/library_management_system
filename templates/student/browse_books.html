{% extends 'base.html' %}
{% block title %}Browse Books{% endblock %}
{% block content %}
<div class="page-header">
  <div class="title-block">
    <span class="kicker">Library</span>
    <h3 class="mb-0">Browse Books</h3>
  </div>
  <div class="action-stack">
    <input id="book-search" class="form-control" placeholder="Search title or author" value="{{ query }}">
    <select id="category-filter" class="form-select" data-selected="{{ selected_category }}">
      <option value="">All Categories</option>
      {% for cat in categories %}
      <option value="{{ cat.id }}" {% if selected_category == cat.id|stringformat:'s' %}selected{% endif %}>{{ cat.name }}</option>
      {% endfor %}
    </select>
  </div>
</div>

<div class="row g-3" id="book-list">
  {% for book in page_obj %}
  <div class="col-md-4 book-card" data-title="{{ book.title|lower }} {{ book.author.name|lower }}" data-category="{{ book.category.id }}">
    <div class="card-modern card-ghost h-100 animate-fade-in">
      <div class="card-body d-flex flex-column">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h5 class="card-title mb-0">{{ book.title }}</h5>
          {% if book.is_available %}<span class="badge-status badge-available">Available</span>{% else %}<span class="badge-status badge-overdue">Out</span>{% endif %}
        </div>
        <p class="text-muted small mb-1">{{ book.author.name }} Â· {{ book.category }}</p>
        <p class="small flex-grow-1">{{ book.description|truncatechars:120 }}</p>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <button class="btn btn-outline-dark btn-sm" data-bs-toggle="modal" data-bs-target="#bookModal" data-title="{{ book.title }}" data-author="{{ book.author.name }}" data-category="{{ book.category }}" data-desc="{{ book.description }}" data-available="{{ book.available_count }}">Details</button>
          {% if user.is_authenticated and user.profile.role == 'STUDENT' and book.is_available %}
          <a class="btn btn-gradient btn-sm" href="{% url 'transactions:request-issue-book' book.id %}">Request</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% empty %}
    <p class="text-muted">No books found.</p>
  {% endfor %}
</div>

<nav class="mt-3">
  <ul class="pagination">
    {% if page_obj.has_previous %}<li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>{% endif %}
    <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
    {% if page_obj.has_next %}<li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>{% endif %}
  </ul>
</nav>

<div class="modal fade modal-modern" id="bookModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" data-modal-title></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="small text-muted" data-modal-meta></p>
        <p data-modal-desc></p>
        <p class="fw-semibold">Available: <span data-modal-avail></span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
